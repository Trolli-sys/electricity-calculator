# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import io
from datetime import datetime, time, date
import calendar
import os
import traceback

# --- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ---
# ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)
TARIFFS = {
    "residential": {
        "normal_le_150": {'service_charge': 8.19, 'type': 'tiered', 'tiers': [{'limit': 15, 'rate': 2.3488}, {'limit': 25, 'rate': 2.9882}, {'limit': 35, 'rate': 3.2405}, {'limit': 100, 'rate': 3.6237}, {'limit': 150, 'rate': 3.7171}, {'limit': 400, 'rate': 4.2218}, {'limit': float('inf'), 'rate': 4.4217}]},
        "normal_gt_150": {'service_charge': 24.62, 'type': 'tiered', 'tiers': [{'limit': 150, 'rate': 3.2484}, {'limit': 400, 'rate': 4.2218}, {'limit': float('inf'), 'rate': 4.4217}]},
        "tou": {'service_charge': 24.62, 'type': 'tou', 'peak_rate': 5.7982, 'off_peak_rate': 2.6369} # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡∏£‡∏≤ TOU ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    },
    "smb": {
        "normal": {'service_charge': 312.24, 'type': 'tiered', 'tiers': [{'limit': 150, 'rate': 3.2484}, {'limit': 400, 'rate': 4.2218}, {'limit': float('inf'), 'rate': 4.4217}]}, # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡∏£‡∏≤ SMB ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        "tou": {'service_charge': 33.29, 'type': 'tou', 'peak_rate': 5.7982, 'off_peak_rate': 2.6369} # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡∏£‡∏≤ TOU ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    }
}

# ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤ Ft (‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≠‡∏á ‡∏Å‡∏Å‡∏û. ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
# ‡∏ó‡∏µ‡πà‡∏°‡∏≤: https://www.erc.or.th/ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏£‡∏¥‡∏á
FT_RATES = {
    # (Year, Month) -> Rate per kWh
    # ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
    (2023, 1): 0.9343, (2023, 5): 0.9119, (2023, 9): 0.2048,
    # ‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ 2024 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á - ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡∏°.‡∏Ñ.-‡πÄ‡∏°.‡∏¢. 67)
    # ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 300 ‡∏´‡∏ô‡πà‡∏ß‡∏¢
    # ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    (2024, 1): 0.3972, # ‡∏°.‡∏Ñ.-‡πÄ‡∏°.‡∏¢. 67
    (2024, 5): 0.3972, # ‡∏û.‡∏Ñ.-‡∏™.‡∏Ñ. 67 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á, ‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏£‡∏¥‡∏á) - ***‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï***
    (2024, 9): 0.3972, # ‡∏Å.‡∏¢.-‡∏ò.‡∏Ñ. 67 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á, ‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏£‡∏¥‡∏á) - ***‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï***
    # ‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ 2025 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á, ‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏£‡∏¥‡∏á) - ***‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï***
    (2025, 1): 0.3672, # ‡∏°.‡∏Ñ.-‡πÄ‡∏°.‡∏¢. 68 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
    (2025, 5): 0.3672, # ‡∏û.‡∏Ñ.-‡∏™.‡∏Ñ. 68 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
    (2025, 9): 0.3672, # ‡∏Å.‡∏¢.-‡∏ò.‡∏Ñ. 68 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
}


# --- ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î TOU ---
# ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏∑‡πà‡∏ô‡πÜ
# ‡∏ó‡∏µ‡πà‡∏°‡∏≤: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏ì‡∏∞‡∏£‡∏±‡∏ê‡∏°‡∏ô‡∏ï‡∏£‡∏µ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
HOLIDAYS_TOU_2024_STR = ["2024-01-01","2024-01-06","2024-01-07","2024-01-13","2024-01-14","2024-01-20","2024-01-21", 
                         "2024-01-27","2024-01-28","2024-02-03","2024-02-04","2024-02-10","2024-02-11","2024-02-17",
                         "2024-02-18","2024-02-24","2024-02-25","2024-03-02","2024-03-03","2024-03-09","2024-03-10",
                         "2024-03-16","2024-03-17","2024-03-23","2024-03-24","2024-03-30","2024-03-31","2024-04-06",
                         "2024-04-07","2024-04-13","2024-04-14","2024-04-15","2024-04-20","2024-04-21","2024-04-27",
                         "2024-04-28","2024-05-01","2024-05-04","2024-05-05","2024-05-11","2024-05-12","2024-05-18",
                         "2024-05-19","2024-05-22","2024-05-25","2024-05-26","2024-06-01","2024-06-02","2024-06-03",
                         "2024-06-08","2024-06-09","2024-06-15","2024-06-16","2024-06-22","2024-06-23","2024-06-29",
                         "2024-06-30","2024-07-06","2024-07-07","2024-07-13","2024-07-14","2024-07-20","2024-07-21",
                         "2024-07-27","2024-07-28","2024-08-03","2024-08-04","2024-08-10","2024-08-11","2024-08-12",
                         "2024-08-17","2024-08-18","2024-08-24","2024-08-25","2024-08-31","2024-09-01","2024-09-07",
                         "2024-09-08","2024-09-14","2024-09-15","2024-09-21","2024-09-22","2024-09-28","2024-09-29",
                         "2024-10-05","2024-10-06","2024-10-12","2024-10-05","2024-10-06","2024-10-12","2024-10-13",
                         "2024-10-19","2024-10-20","2024-10-23","2024-10-26","2024-10-27","2024-11-02","2024-11-03",
                         "2024-11-09","2024-11-10","2024-11-16","2024-11-17","2024-11-23","2024-11-24","2024-11-30",
                         "2024-12-01","2024-12-05","2024-12-07","2024-12-08","2024-12-10","2024-12-14","2024-12-15",
                         "2024-12-21","2024-12-22","2024-12-28","2024-12-29","2024-12-31"]
# ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏µ 2025 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡∏ì ‡∏õ‡∏•‡∏≤‡∏¢‡∏õ‡∏µ 2024 - ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
HOLIDAYS_TOU_2025_STR = ["2025-01-01","2025-01-04","2025-01-05","2025-01-11","2025-01-12","2025-01-18","2025-01-19",
                         "2025-01-25","2025-01-26","2025-02-01","2025-02-02","2025-02-08","2025-02-09","2025-02-12",
                         "2025-02-15","2025-02-16","2025-02-22","2025-02-23","2025-03-01","2025-03-02","2025-03-08",
                         "2025-03-09","2025-03-15","2025-03-16","2025-03-22","2025-03-23","2025-03-29","2025-03-30",
                         "2025-04-05","2025-04-06","2025-04-12","2025-04-13","2025-04-14","2025-04-15","2025-04-19",
                         "2025-04-20","2025-04-26","2025-04-27","2025-05-01","2025-05-03","2025-05-04","2025-05-10",
                         "2025-05-11","2025-05-17","2025-05-18","2025-05-24","2025-05-25","2025-05-31","2025-06-01",
                         "2025-06-03","2025-06-07","2025-06-08","2025-06-14","2025-06-15","2025-06-21","2025-06-22",
                         "2025-06-28","2025-06-29","2025-07-05","2025-07-06","2025-07-10","2025-07-11","2025-07-12",
                         "2025-07-13","2025-07-19","2025-07-20","2025-07-26","2025-07-27","2025-07-28","2025-08-02",
                         "2025-08-09","2025-08-10","2025-08-12","2025-08-16","2025-08-17","2025-08-23","2025-08-24",
                         "2025-08-30","2025-08-31","2025-09-06","2025-09-07","2025-09-13","2025-09-14","2025-09-20",
                         "2025-09-21","2025-09-27","2025-09-28","2025-10-04","2025-10-05","2025-10-11","2025-10-12",
                         "2025-10-13","2025-10-18","2025-10-19","2025-10-23","2025-10-25","2025-10-26","2025-11-01",
                         "2025-11-02","2025-11-08","2025-11-09","2025-11-15","2025-11-16","2025-11-22","2025-11-23",
                         "2025-11-29","2025-11-30","2025-12-05","2025-12-06","2025-12-07","2025-12-10","2025-12-13",
                         "2025-12-14","2025-12-20","2025-12-21","2025-12-27","2025-12-28","2025-12-31"]
# ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö)
HOLIDAYS_TOU_2025_STR = sorted(list(set(HOLIDAYS_TOU_2025_STR)))

HOLIDAYS_TOU_DATA = {}
try:
    HOLIDAYS_TOU_DATA[2024] = set(datetime.strptime(d, "%Y-%m-%d").date() for d in HOLIDAYS_TOU_2024_STR)
    HOLIDAYS_TOU_DATA[2025] = set(datetime.strptime(d, "%Y-%m-%d").date() for d in HOLIDAYS_TOU_2025_STR)
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
except ValueError as e:
    error_message = f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: {e}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô HOLIDAYS_TOU_xxx_STR."
    print(error_message)
    st.error(error_message) # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    HOLIDAYS_TOU_DATA = {} # ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

VAT_RATE = 0.07
PEAK_START = time(9, 0, 0)
PEAK_END = time(21, 59, 59) # 9:00:00 ‡∏ñ‡∏∂‡∏á 21:59:59 ‡∏Ñ‡∏∑‡∏≠ Peak
MONTH_NAMES_TH = {1: "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", 2: "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", 3: "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", 4: "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
                  5: "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", 6: "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", 7: "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", 8: "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
                  9: "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", 10: "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", 11: "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", 12: "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"}
HOURS = [f"{h:02d}" for h in range(24)]
MINUTES = ["00", "15", "30", "45"]


# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Helper (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á parse_data_file) ---

# @st.cache_data # ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏ä‡πâ cache ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥
def parse_data_file(uploaded_file):
    """
    ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Load Profile ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡πà‡∏≤‡∏ô Streamlit
    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå Tab-separated (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞) ‡πÅ‡∏•‡∏∞ CSV ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
    - CSV 7 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤ DateTime ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà index 1, Demand (kW) ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà index 3
    - CSV >=8 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤ DateTime ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà index 1, Demand (W) ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà index 3
    ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Encoding (UTF-8, CP874/TIS-620) ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD ‡∏´‡∏£‡∏∑‡∏≠ DD/MM/YYYY)
    """
    df_final = None
    file_content_string = ""
    detected_encoding = None
    detected_delimiter = None
    first_line = ""

    # 1. ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Encoding
    encodings_to_try = ['utf-8', 'cp874', 'tis-620']
    for enc in encodings_to_try:
        try:
            uploaded_file.seek(0) # ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå
            bytes_content = uploaded_file.getvalue()
            file_content_string = bytes_content.decode(enc)
            detected_encoding = enc
            st.write(f"‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢ Encoding: {detected_encoding}")
            # ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô
            # ‡πÉ‡∏ä‡πâ splitlines() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö \r\n ‡∏´‡∏£‡∏∑‡∏≠ \n
            first_line = file_content_string.splitlines()[0].strip() if file_content_string else ""
            break # ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å loop
        except UnicodeDecodeError:
            st.write(f"‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢ {enc} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à...")
            continue # ‡∏•‡∏≠‡∏á encoding ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        except IndexError: # ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á decode
             raise ValueError("‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ")
        except Exception as e:
            raise ValueError(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î‡∏Ç‡∏ì‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢ {enc}: {e}")

    if not detected_encoding:
        raise ValueError(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢ Encoding ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ({', '.join(encodings_to_try)})")
    if not first_line:
         raise ValueError("‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ")

    # 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô (Tab ‡∏´‡∏£‡∏∑‡∏≠ Comma)
    if '\t' in first_line:
        detected_delimiter = '\t'
        st.write("‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô: Tab (\\t)")
    elif ',' in first_line:
        detected_delimiter = ','
        st.write("‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô: Comma (,)")
    else:
        # ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡∏≠‡∏≤‡∏à‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß? (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏à‡πâ‡∏á error)
        raise ValueError(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (Tab ‡∏´‡∏£‡∏∑‡∏≠ Comma) ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å: '{first_line}'")

    # --- ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô ---
    data_io = io.StringIO(file_content_string) # ‡πÉ‡∏ä‡πâ string ‡∏ó‡∏µ‡πà‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß

    try:
        # 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Tab-Separated
        if detected_delimiter == '\t':
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Header ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Tab ‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
            if first_line.strip() == "DateTime\tTotal import kW demand":
                st.write("‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: Tab-separated (Header ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)")
                # header=0 ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô Header
                df = pd.read_csv(data_io, sep='\t', header=0, skipinitialspace=True, low_memory=False)
                df.columns = df.columns.str.strip() # ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå

                required_cols = ['DateTime', 'Total import kW demand']
                if not all(col in df.columns for col in required_cols):
                    raise ValueError(f"‡πÑ‡∏ü‡∏•‡πå Tab ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: {', '.join(required_cols)}")

                # ‡πÅ‡∏õ‡∏•‡∏á DateTime (‡πÉ‡∏ä‡πâ dayfirst=True ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö format ‡∏ô‡∏µ‡πâ)
                df['DateTime_parsed'] = pd.to_datetime(df['DateTime'], dayfirst=True, errors='coerce')
                # ‡πÅ‡∏õ‡∏•‡∏á Demand (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô kW ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                df['Demand_parsed'] = pd.to_numeric(df['Total import kW demand'], errors='coerce')

                # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                df_final = df.dropna(subset=['DateTime_parsed', 'Demand_parsed']) \
                             .rename(columns={'DateTime_parsed': 'DateTime',
                                              'Demand_parsed': 'Total import kW demand'}) \
                             [['DateTime', 'Total import kW demand']].copy()
            else:
                raise ValueError("‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Tab-separated ‡πÅ‡∏ï‡πà Header ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á ('DateTime\\tTotal import kW demand')")

        # 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Comma-Separated
        elif detected_delimiter == ',':
            # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô
            # ‡πÉ‡∏ä‡πâ low_memory=False ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö dtype ‡∏ï‡∏≠‡∏ô‡∏≠‡πà‡∏≤‡∏ô
            try:
                df_check = pd.read_csv(io.StringIO(file_content_string), sep=',', header=None, skipinitialspace=True, nrows=10, low_memory=False)
                num_cols = df_check.shape[1]
                st.write(f"‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: CSV ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {num_cols} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå")
            except pd.errors.EmptyDataError:
                 raise ValueError("‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤")
            except Exception as read_err:
                 raise ValueError(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV: {read_err}")


            # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î index ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å 0)
            datetime_col_idx = 1
            demand_col_idx = 3

            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if num_cols <= max(datetime_col_idx, demand_col_idx):
                 raise ValueError(f"‡πÑ‡∏ü‡∏•‡πå CSV ‡∏°‡∏µ {num_cols} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ DateTime ‡∏ó‡∏µ‡πà index {datetime_col_idx}, Demand ‡∏ó‡∏µ‡πà index {demand_col_idx})")

            # ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ï‡πá‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏î‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ header ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô header ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ header=0)
            header_setting = None # Default to no header
            try:
                 first_row_values = df_check.iloc[0].astype(str).tolist()
                 # ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏á‡πà‡∏≤‡∏¢‡πÜ: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô header
                 if any(any(c.isalpha() for c in str(item)) for item in first_row_values[:4]):
                     header_setting = 0
                 st.write(f"‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô CSV: ‡πÉ‡∏ä‡πâ header={header_setting}")
                 df = pd.read_csv(data_io, sep=',', header=header_setting, skipinitialspace=True, low_memory=False)
            except Exception as read_err:
                 st.warning(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô CSV ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ({read_err}), ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ Header...")
                 data_io.seek(0) # ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï buffer
                 df = pd.read_csv(data_io, sep=',', header=None, skipinitialspace=True, low_memory=False)

            # --- ‡πÅ‡∏õ‡∏•‡∏á DateTime (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå index 1) ---
            if datetime_col_idx >= df.shape[1]:
                 raise ValueError(f"Index ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå DateTime ({datetime_col_idx}) ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ({df.shape[1]} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)")

            dt_str_series = df.iloc[:, datetime_col_idx].astype(str).str.strip()

            # ‡πÄ‡∏î‡∏≤ dayfirst ‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            dayfirst_guess = False
            # ‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ '/' ‡∏´‡∏£‡∏∑‡∏≠ '-'
            potential_dates = dt_str_series[dt_str_series.str.contains(r'[\/\-:]', regex=True) & dt_str_series.notna()].head(20) # ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
            guessed = False
            for s in potential_dates:
                if '/' in s: # ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY
                    try:
                        # ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏Å‡πà‡∏≠‡∏ô space ‡πÅ‡∏£‡∏Å) ‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ '/' ‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏£‡∏Å (day)
                        day_part_str = s.split(' ')[0].split('/')[0]
                        if day_part_str.isdigit():
                             day_part = int(day_part_str)
                             if day_part > 12:
                                 dayfirst_guess = True
                                 st.write("‚úîÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY (day > 12)")
                                 guessed = True
                                 break
                    except Exception:
                         pass # ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏î‡πâ, ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
                elif '-' in s: # ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
                    st.write("‚úîÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ('-' separator)")
                    dayfirst_guess = False # YYYY-MM-DD ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà dayfirst
                    guessed = True
                    break
            if not guessed and not potential_dates.empty:
                 st.write("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏î‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DD/MM ‡∏´‡∏£‡∏∑‡∏≠ YYYY-MM) ‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô, ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô dayfirst=False")


            st.write(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á DateTime ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {datetime_col_idx+1} ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ dayfirst={dayfirst_guess}")
            dt_series = pd.to_datetime(dt_str_series, dayfirst=dayfirst_guess, errors='coerce')

            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á
            null_dates = dt_series.isnull().sum()
            total_rows = len(df)
            if null_dates > total_rows * 0.9: # ‡∏ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î > 90% ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                # ‡∏•‡∏≠‡∏á‡∏™‡∏•‡∏±‡∏ö dayfirst ‡∏î‡∏π ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏≤
                if not guessed:
                     st.write(f"‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á DateTime ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ dayfirst={not dayfirst_guess}")
                     dt_series_alt = pd.to_datetime(dt_str_series, dayfirst=(not dayfirst_guess), errors='coerce')
                     if dt_series_alt.isnull().sum() < null_dates: # ‡∏ñ‡πâ‡∏≤‡∏ú‡∏•‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
                          st.write("‚úîÔ∏è ‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö dayfirst ‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô")
                          dt_series = dt_series_alt
                          null_dates = dt_series.isnull().sum()

            if null_dates == total_rows:
                 raise ValueError(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà {datetime_col_idx+1} ‡πÄ‡∏õ‡πá‡∏ô DateTime ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
            elif null_dates > 0:
                 st.warning(f"‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà {datetime_col_idx+1} ‡πÄ‡∏õ‡πá‡∏ô DateTime ‡πÑ‡∏î‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {null_dates}/{total_rows} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")


            # --- ‡πÅ‡∏õ‡∏•‡∏á Demand (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå index 3) ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢ ---
            if demand_col_idx >= df.shape[1]:
                 raise ValueError(f"Index ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Demand ({demand_col_idx}) ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ({df.shape[1]} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)")

            # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç, ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö error ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô NaN
            demand_series_numeric = pd.to_numeric(df.iloc[:, demand_col_idx], errors='coerce')
            null_demand = demand_series_numeric.isnull().sum()

            if null_demand == total_rows:
                 raise ValueError(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà {demand_col_idx+1} ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Demand) ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢")
            elif null_demand > 0:
                 st.warning(f"‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà {demand_col_idx+1} ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {null_demand}/{total_rows} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)")


            # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
            if num_cols >= 8:
                # ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Watts ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå >= 8 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÄ‡∏ä‡πà‡∏ô PRECISE, KY)
                demand_series_kw = demand_series_numeric / 1000.0
                unit_assumption = "W (‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏≤‡∏£ 1000 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô kW)"
            elif num_cols == 7:
                # ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô kW ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå 7 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÄ‡∏ä‡πà‡∏ô 0062*)
                demand_series_kw = demand_series_numeric
                unit_assumption = "kW (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°)"
            else:
                # ‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                raise ValueError(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ({num_cols}) ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö")

            st.write(f"‚úîÔ∏è ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢ Demand ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {demand_col_idx+1} ‡πÄ‡∏õ‡πá‡∏ô: {unit_assumption}")

            # --- ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ---
            df_temp = pd.DataFrame({'DateTime': dt_series, 'Total import kW demand': demand_series_kw})
            # ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà DateTime ‡∏´‡∏£‡∏∑‡∏≠ Demand ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (NaN/NaT)
            df_final = df_temp.dropna(subset=['DateTime', 'Total import kW demand']).copy()

        # ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CSV
        else:
             raise ValueError("Internal Error: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ") # ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        if df_final is None or df_final.empty:
            raise ValueError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤)")

        # ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ dtype ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô
        df_final['DateTime'] = pd.to_datetime(df_final['DateTime'])
        df_final['Total import kW demand'] = pd.to_numeric(df_final['Total import kW demand'])

        st.success(f"‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏û‡∏ö {len(df_final)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
        st.write("‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•:")
        st.dataframe(df_final.head()) # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
        return df_final

    except pd.errors.EmptyDataError:
        raise ValueError("‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤")
    except ValueError as ve: # ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ValueError ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏≠‡∏á
        raise ve
    except Exception as e:
        st.error(f"Traceback: {traceback.format_exc()}") # ‡πÅ‡∏™‡∏î‡∏á traceback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debugging
        raise ValueError(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ Pandas: {e}")


# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (classify_tou_period, get_ft_rate, calculate_bill) ---
# (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)

def classify_tou_period(dt_obj):
    """‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Peak/Off-Peak ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤ TOU"""
    if not isinstance(dt_obj, datetime): return 'Unknown'
    current_date = dt_obj.date()
    current_time = dt_obj.time()
    day_of_week = dt_obj.weekday() # Monday is 0 and Sunday is 6

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ
    year_holidays = HOLIDAYS_TOU_DATA.get(current_date.year)
    if year_holidays is None:
        if current_date.year not in st.session_state.get('missing_holiday_years', set()):
             st.warning(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î TOU ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ {current_date.year}. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì TOU ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô")
             if 'missing_holiday_years' not in st.session_state: st.session_state.missing_holiday_years = set()
             st.session_state.missing_holiday_years.add(current_date.year)

    # 1. ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå (‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏î‡πÄ‡∏ä‡∏¢) -> Off-Peak ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô
    if year_holidays and current_date in year_holidays:
        return 'Off-Peak'

    # 2. ‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå -> Off-Peak ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô
    if day_of_week >= 5: # Saturday (5), Sunday (6)
        return 'Off-Peak'

    # 3. ‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå)
    # ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 9:00:00 - 21:59:59 ‡∏Ñ‡∏∑‡∏≠ Peak
    if PEAK_START <= current_time <= PEAK_END:
        return 'Peak'
    else: # ‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ Off-Peak
        return 'Off-Peak'

def get_ft_rate(date_in_period):
    """‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤ Ft ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î"""
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á input ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô date object
    if isinstance(date_in_period, datetime):
        date_in_period = date_in_period.date()
    elif not isinstance(date_in_period, date):
         # ‡πÉ‡∏ä‡πâ fallback ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡πâ‡∏≤ input ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
         fallback_date = datetime.now().date()
         if 'invalid_date_ft_warn' not in st.session_state:
             st.warning(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ('{date_in_period}') ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Ft, ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ({fallback_date}) ‡πÅ‡∏ó‡∏ô")
             print(f"Warning: Invalid date type ({type(date_in_period)}) passed to get_ft_rate. Using current date.")
             st.session_state.invalid_date_ft_warn = True # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
         date_in_period = fallback_date

    applicable_rate = None
    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Ft ‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
    sorted_ft_periods = sorted(FT_RATES.keys(), reverse=True)

    # ‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á Ft ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô
    for start_year, start_month in sorted_ft_periods:
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á Ft (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
        ft_period_start_date = date(start_year, start_month, 1)
        if date_in_period >= ft_period_start_date:
            applicable_rate = FT_RATES[(start_year, start_month)]
            # st.write(f"DEBUG Ft: Found rate {applicable_rate} for period starting {start_year}-{start_month} for date {date_in_period}")
            break # ‡πÄ‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤

    if applicable_rate is None:
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢ (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Ft ‡∏ó‡∏µ‡πà‡∏°‡∏µ)
        if 'ft_not_found_warn' not in st.session_state:
            st.warning(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤ Ft ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {date_in_period} ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤. ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Ft=0.0")
            print(f"Warning: Ft rate not found for period including {date_in_period}. Using Ft=0.0")
            st.session_state.ft_not_found_warn = True # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        applicable_rate = 0.0

    return applicable_rate


def calculate_bill(df_processed, customer_type, tariff_type):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏à‡∏≤‡∏Å DataFrame ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß"""
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
    if df_processed is None or df_processed.empty:
        return {"error": "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"}
    required_cols = ['DateTime', 'kWh']
    if not all(col in df_processed.columns for col in required_cols):
        return {"error": f"Internal error: ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ({', '.join(required_cols)})"}
    if not pd.api.types.is_datetime64_any_dtype(df_processed['DateTime']):
         return {"error": "Internal error: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå DateTime ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"}
    if not pd.api.types.is_numeric_dtype(df_processed['kWh']):
         # ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô numeric ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤
         df_processed['kWh'] = pd.to_numeric(df_processed['kWh'], errors='coerce')
         if df_processed['kWh'].isnull().any():
              return {"error": "Internal error: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå kWh ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç"}
         st.warning("‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á dtype ‡∏Ç‡∏≠‡∏á kWh ‡πÉ‡∏ô calculate_bill")

    # --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---
    total_kwh = df_processed['kWh'].sum()
    kwh_peak, kwh_off_peak = 0.0, 0.0 # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô float
    df_temp = df_processed.copy() # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö copy ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°

    # ‡∏´‡∏≤‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞ Ft (‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
    data_period_end_dt = df_temp['DateTime'].iloc[-1] if not df_temp.empty else datetime.now()
    data_year = data_period_end_dt.year
    relevant_date_for_ft = data_period_end_dt.date() # ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤ Ft

    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Peak/Off-peak ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤ TOU
    if tariff_type == 'tou':
        df_temp['TOU_Period'] = df_temp['DateTime'].apply(classify_tou_period)
        # st.write("DEBUG: ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó TOU:") # Debugging statement
        # st.dataframe(df_temp[['DateTime', 'kWh', 'TOU_Period']].head(10)) # Debugging statement

        kwh_summary = df_temp.groupby('TOU_Period')['kWh'].sum()
        kwh_peak = kwh_summary.get('Peak', 0.0)
        # ‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Unknown) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö Off-Peak
        kwh_off_peak = kwh_summary.get('Off-Peak', 0.0) + kwh_summary.get('Unknown', 0.0)

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢
        if abs((kwh_peak + kwh_off_peak) - total_kwh) > 0.01: # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
             st.warning(f"‡∏ú‡∏•‡∏£‡∏ß‡∏° Peak ({kwh_peak:.4f}) + Off-peak ({kwh_off_peak:.4f}) ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° kWh ({total_kwh:.4f}) ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢. ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó TOU.")
             print(f"Warning: Peak/Off-peak sum ({kwh_peak + kwh_off_peak:.4f}) differs slightly from total kWh ({total_kwh:.4f}).")

    # --- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ---
    try:
        if customer_type == "residential":
            if tariff_type == "normal":
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (<=150 ‡∏´‡∏£‡∏∑‡∏≠ >150)
                tariff_key = "normal_le_150" if total_kwh <= 150 else "normal_gt_150"
                rate_structure = TARIFFS["residential"][tariff_key]
            elif tariff_type == "tou":
                rate_structure = TARIFFS["residential"]["tou"]
            else: raise ValueError("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
        elif customer_type == "smb":
            if tariff_type == "normal":
                rate_structure = TARIFFS["smb"]["normal"]
            elif tariff_type == "tou":
                rate_structure = TARIFFS["smb"]["tou"]
            else: raise ValueError("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
        else: raise ValueError("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
    except KeyError as e:
        return {"error": f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: {e}. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà TARIFFS."}
    except ValueError as e:
        return {"error": str(e)}

    # --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ê‡∏≤‡∏ô ---
    base_energy_cost = 0.0
    if rate_structure['type'] == 'tiered':
        last_limit = 0
        for tier in rate_structure['tiers']:
            limit, rate = tier['limit'], tier['rate']
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ
            units_in_tier = max(0, min(total_kwh, limit) - last_limit)
            if units_in_tier > 0:
                base_energy_cost += units_in_tier * rate
            last_limit = limit
            # ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô inf)
            if total_kwh <= limit and limit != float('inf'):
                break
    elif rate_structure['type'] == 'tou':
        base_energy_cost = (kwh_peak * rate_structure['peak_rate']) + \
                           (kwh_off_peak * rate_structure['off_peak_rate'])

    # --- ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ---
    service_charge = rate_structure['service_charge']

    # --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ Ft ---
    applicable_ft_rate = get_ft_rate(relevant_date_for_ft) # ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏´‡∏≤‡πÑ‡∏ß‡πâ
    ft_cost = total_kwh * applicable_ft_rate

    # --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ---
    total_before_vat = base_energy_cost + service_charge + ft_cost
    vat_amount = total_before_vat * VAT_RATE
    final_bill = total_before_vat + vat_amount

    # --- ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
    result = {
        "customer_type": customer_type, "tariff_type": tariff_type,
        "data_period_start": df_temp['DateTime'].iloc[0].strftime('%Y-%m-%d %H:%M:%S') if not df_temp.empty else "N/A",
        "data_period_end": data_period_end_dt.strftime('%Y-%m-%d %H:%M:%S'),
        "data_year": data_year, # ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/Ft
        "total_kwh": round(total_kwh, 4),
        "kwh_peak": round(kwh_peak, 4) if tariff_type == 'tou' else None,
        "kwh_off_peak": round(kwh_off_peak, 4) if tariff_type == 'tou' else None,
        "base_energy_cost": round(base_energy_cost, 2),
        "service_charge": round(service_charge, 2),
        "applicable_ft_rate": round(applicable_ft_rate, 4),
        "ft_cost": round(ft_cost, 2),
        "total_before_vat": round(total_before_vat, 2),
        "vat_amount": round(vat_amount, 2),
        "final_bill": round(final_bill, 2),
        "error": None # ‡πÑ‡∏°‡πà‡∏°‡∏µ error
    }
    return result
# --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Helper ---


# --- Streamlit App ---
st.set_page_config(page_title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", layout="wide")
st.title("üìä ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (‡∏à‡∏≥‡∏•‡∏≠‡∏á EV)")

# --- Session State Initialization ---
# ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ
if 'full_dataframe' not in st.session_state:
    st.session_state.full_dataframe = None # DataFrame ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
if 'available_years' not in st.session_state:
    st.session_state.available_years = [] # ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå
if 'available_months_th' not in st.session_state:
    st.session_state.available_months_th = [] # ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢)
if 'calculation_result' not in st.session_state:
    st.session_state.calculation_result = "" # ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
if 'last_uploaded_filename' not in st.session_state:
    st.session_state.last_uploaded_filename = None # ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à


# --- ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ---
st.header("1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Load Profile")
uploaded_file = st.file_uploader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (.txt ‡∏´‡∏£‡∏∑‡∏≠ .csv)", type=['txt', 'csv'], key="file_uploader")

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
if uploaded_file is not None:
    # ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
    if st.session_state.full_dataframe is None or uploaded_file.name != st.session_state.get('last_uploaded_filename'):
        st.info(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà: {uploaded_file.name}...")
        try:
            with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà'):
                # ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                st.session_state.full_dataframe = None
                st.session_state.available_years = []
                st.session_state.available_months_th = []
                st.session_state.calculation_result = ""
                # ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÜ
                st.session_state.missing_holiday_years = set()
                if 'invalid_date_ft_warn' in st.session_state: del st.session_state.invalid_date_ft_warn
                if 'ft_not_found_warn' in st.session_state: del st.session_state.ft_not_found_warn

                # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parse_data_file ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
                df_parsed = parse_data_file(uploaded_file)

                # ‡πÄ‡∏Å‡πá‡∏ö DataFrame ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                if df_parsed is not None and not df_parsed.empty:
                    st.session_state.full_dataframe = df_parsed
                    st.session_state.last_uploaded_filename = uploaded_file.name # ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

                    # ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å DataFrame (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö dtype ‡∏Å‡πà‡∏≠‡∏ô)
                    if not pd.api.types.is_datetime64_any_dtype(st.session_state.full_dataframe['DateTime']):
                         st.session_state.full_dataframe['DateTime'] = pd.to_datetime(st.session_state.full_dataframe['DateTime'], errors='coerce')
                         st.session_state.full_dataframe.dropna(subset=['DateTime'], inplace=True) # ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ

                    if not st.session_state.full_dataframe.empty:
                        st.session_state.available_years = sorted(st.session_state.full_dataframe['DateTime'].dt.year.unique())
                        available_months_num = sorted(st.session_state.full_dataframe['DateTime'].dt.month.unique())
                        st.session_state.available_months_th = [MONTH_NAMES_TH.get(m, str(m)) for m in available_months_num]
                        #‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á st.success ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏ô parse_data_file
                    else:
                         st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á DateTime ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")
                         st.session_state.full_dataframe = None # ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤

                # ‡∏Å‡∏£‡∏ì‡∏µ parse_data_file ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ None ‡∏´‡∏£‡∏∑‡∏≠ Empty (‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£ raise error)
                # else:
                #     st.session_state.full_dataframe = None
                #     st.error("‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ")

        except ValueError as ve:
            st.session_state.full_dataframe = None # ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            st.session_state.last_uploaded_filename = None
            st.error(f"‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: {ve}")
        except Exception as ex:
            st.session_state.full_dataframe = None # ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            st.session_state.last_uploaded_filename = None
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î: {ex}")
            st.error(f"Traceback: {traceback.format_exc()}") # ‡πÅ‡∏™‡∏î‡∏á traceback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) ---
if st.session_state.full_dataframe is not None and not st.session_state.full_dataframe.empty:
    st.markdown("---")
    st.header("2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")

    col1, col2 = st.columns(2) # ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå

    with col1:
        # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        customer_options = ["‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢", "‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å"]
        selected_customer = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:", customer_options, key="customer_type")

        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ
        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ available_years ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        year_options = ["‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ"] + st.session_state.get('available_years', [])
        selected_year = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ:", year_options, key="year")

    with col2:
        # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤
        tariff_options = ["‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏≠‡∏±‡∏ï‡∏£‡∏≤ TOU"]
        selected_tariff = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤:", tariff_options, key="tariff_type")

        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ available_months_th ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        month_options = ["‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"] + st.session_state.get('available_months_th', [])
        selected_month = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:", month_options, key="month")

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á EV Charger ---
    with st.expander("üîå ‡∏à‡∏≥‡∏•‡∏≠‡∏á EV Charger (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)"):
        ev_enabled = st.checkbox("‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á EV", key="ev_enabled")

        ev_col1, ev_col2, ev_col3 = st.columns(3)
        with ev_col1:
             # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ min/max/default ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
             ev_power_kw = st.number_input("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏ü Charger (kW):", min_value=0.1, max_value=50.0, value=7.0, step=0.1, format="%.1f", key="ev_power", disabled=not ev_enabled)
        with ev_col2:
             # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡πÄ‡∏ä‡πà‡∏ô 22:00)
             ev_start_hour = st.selectbox("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏£‡πå‡∏à (‡∏ä‡∏°.):", HOURS, index=22, key="ev_start_h", disabled=not ev_enabled)
             ev_start_min = st.selectbox("‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°:", MINUTES, index=0, key="ev_start_m", disabled=not ev_enabled)
        with ev_col3:
             # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡πÄ‡∏ä‡πà‡∏ô 05:00)
             ev_end_hour = st.selectbox("‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏ä‡∏°.):", HOURS, index=5, key="ev_end_h", disabled=not ev_enabled)
             ev_end_min = st.selectbox("‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:", MINUTES, index=0, key="ev_end_m", disabled=not ev_enabled)

    st.markdown("---")

    # --- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---
    if st.button("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü", type="primary", key="calculate_button"):
        st.session_state.calculation_result = "" # ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πà‡∏≤
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤..."):
            try:
                # --- 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
                df_filtered = st.session_state.full_dataframe.copy() # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö copy

                # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
                if selected_year != "‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ":
                    try:
                         year_int = int(selected_year)
                         df_filtered = df_filtered[df_filtered['DateTime'].dt.year == year_int]
                    except ValueError:
                         st.error(f"‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {selected_year}")
                         raise # ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î

                # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                if selected_month != "‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô":
                    month_num = None
                    for num, name in MONTH_NAMES_TH.items():
                        if name == selected_month:
                            month_num = num
                            break
                    if month_num:
                        df_filtered = df_filtered[df_filtered['DateTime'].dt.month == month_num]
                    else:
                        # ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏±‡∏ö selectbox ‡πÅ‡∏ï‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ)
                        st.warning(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '{selected_month}'. ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ")

                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if df_filtered.empty:
                    st.warning(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '{selected_month} ‡∏õ‡∏µ {selected_year}' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ")
                    st.session_state.calculation_result = f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '{selected_month} ‡∏õ‡∏µ {selected_year}'"
                else:
                    st.write(f"‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {len(df_filtered)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")

                    # --- 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á EV Charger ---
                    ev_charging_intervals = 0
                    ev_kwh_added = 0.0
                    ev_details_for_output = ""
                    charge_start_time = None
                    charge_end_time = None
                    original_total_demand = df_filtered['Total import kW demand'].sum() # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö

                    if ev_enabled:
                        try:
                            # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å session_state ‡∏ï‡∏≤‡∏° key ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                            start_h = int(st.session_state.ev_start_h)
                            start_m = int(st.session_state.ev_start_m)
                            end_h = int(st.session_state.ev_end_h)
                            end_m = int(st.session_state.ev_end_m)
                            ev_power = float(st.session_state.ev_power) # ‡πÉ‡∏ä‡πâ ev_power ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ev_power_kw
                            if ev_power <= 0: raise ValueError("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏ü EV ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0")

                            charge_start_time = time(start_h, start_m)
                            charge_end_time = time(end_h, end_m)

                            ev_details_for_output = f"‡∏à‡∏≥‡∏•‡∏≠‡∏á EV Charger: {ev_power:.2f} kW ({start_h:02d}:{start_m:02d} - {end_h:02d}:{end_m:02d})\n"

                            # ‡∏™‡∏£‡πâ‡∏≤‡∏á mask ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à
                            time_series = df_filtered['DateTime'].dt.time
                            if charge_start_time <= charge_end_time: # ‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏°‡πà‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ô
                                charging_mask = (time_series >= charge_start_time) & (time_series < charge_end_time) # ‡πÉ‡∏ä‡πâ < end time ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° interval ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                            else: # ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 22:00 - 05:00)
                                charging_mask = (time_series >= charge_start_time) | (time_series < charge_end_time)

                            # ‡πÄ‡∏û‡∏¥‡πà‡∏° demand ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à
                            df_filtered.loc[charging_mask, 'Total import kW demand'] += ev_power
                            ev_charging_intervals = charging_mask.sum()

                            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì kWh ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢ 15 ‡∏ô‡∏≤‡∏ó‡∏µ = 0.25 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
                            # ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö interval ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
                            interval_hours = 0.25 # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ
                            ev_kwh_added = ev_charging_intervals * ev_power * interval_hours
                            st.write(f"‚úîÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î EV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ({ev_charging_intervals} ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤, {ev_kwh_added:.2f} kWh)")

                        except ValueError as ve:
                            st.error(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EV ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {ve}")
                            ev_details_for_output = f"‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EV ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {ve}\n"
                            # ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÇ‡∏´‡∏•‡∏î EV ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏ï‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                        except Exception as ex_ev:
                            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• EV Charger: {ex_ev}")
                            ev_details_for_output = f"‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• EV: {ex_ev}\n"


                    # --- 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì kWh ‡∏à‡∏≤‡∏Å kW Demand ---
                    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢ 15 ‡∏ô‡∏≤‡∏ó‡∏µ (0.25 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
                    # ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ interval ‡∏≠‡∏∑‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ô‡∏µ‡πâ
                    interval_hours = 0.25
                    df_filtered['kWh'] = df_filtered['Total import kW demand'] * interval_hours

                    # --- 4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü ---
                    # ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
                    customer_key = "residential" if selected_customer == "‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢" else "smb"
                    tariff_key = "normal" if selected_tariff == "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥" else "tou"

                    bill_details = calculate_bill(df_filtered, customer_key, tariff_key)

                    # --- 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
                    if bill_details.get("error"):
                        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: {bill_details['error']}")
                        st.session_state.calculation_result = f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:\n{bill_details['error']}"
                    else:
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        calculation_period = ""
                        if selected_year == "‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ" and selected_month == "‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": calculation_period = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå"
                        elif selected_year == "‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ": calculation_period = f"‡πÄ‡∏î‡∏∑‡∏≠‡∏ô{selected_month} (‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå)"
                        elif selected_month == "‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": calculation_period = f"‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ {selected_year}"
                        else: calculation_period = f"{selected_month} {selected_year}"

                        output = f"--- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ({calculation_period}) ---\n"
                        if ev_enabled: output += ev_details_for_output # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î EV ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        output += f"‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {st.session_state.last_uploaded_filename}\n"
                        output += f"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {selected_customer}\n"
                        output += f"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤: {selected_tariff}\n"
                        output += f"‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: {bill_details['data_period_start']} ‡∏ñ‡∏∂‡∏á {bill_details['data_period_end']}\n"
                        output += f"‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏£‡∏ß‡∏°: {bill_details['total_kwh']:.2f} kWh\n"

                        # ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å EV ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á
                        if ev_enabled and ev_kwh_added > 0:
                            output += f"  - ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å EV: {ev_kwh_added:.2f} kWh ({ev_charging_intervals} ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ x {interval_hours} ‡∏ä‡∏°.)\n"

                        # ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢ Peak/Off-peak ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô TOU
                        if bill_details['tariff_type'] == 'tou':
                            output += f"  - Peak: {bill_details['kwh_peak']:.2f} kWh\n"
                            output += f"  - Off-Peak: {bill_details['kwh_off_peak']:.2f} kWh\n"

                        # ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                        output += "----------------------------------------\n"
                        output += f"‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤: {bill_details['base_energy_cost']:>18,.2f} ‡∏ö‡∏≤‡∏ó\n"
                        output += f"‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {bill_details['service_charge']:>19,.2f} ‡∏ö‡∏≤‡∏ó\n"

                        # ‡∏Ñ‡πà‡∏≤ Ft ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
                        ft_rate_for_period = bill_details['applicable_ft_rate']
                        ft_year_used = bill_details['data_year'] # ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏´‡∏≤ Ft
                        output += f"‡∏Ñ‡πà‡∏≤ Ft (@{ft_rate_for_period:.4f} ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢, ‡∏õ‡∏µ {ft_year_used}): {bill_details['ft_cost']:>6,.2f} ‡∏ö‡∏≤‡∏ó\n"

                        # ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞ VAT
                        output += "----------------------------------------\n"
                        output += f"‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT: {bill_details['total_before_vat']:>20,.2f} ‡∏ö‡∏≤‡∏ó\n"
                        output += f"‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° ({VAT_RATE*100:.0f}%): {bill_details['vat_amount']:>13,.2f} ‡∏ö‡∏≤‡∏ó\n"
                        output += "========================================\n"
                        output += f"**‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:** {bill_details['final_bill']:>18,.2f} **‡∏ö‡∏≤‡∏ó**\n"
                        output += "========================================\n"

                        # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        output += f"\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:\n"
                        output += f"- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {len(df_filtered)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ {interval_hours*60:.0f} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)\n"
                        output += f"- ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Ft ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î TOU ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ({bill_details['data_period_end'].split(' ')[0]})\n"
                        if bill_details['tariff_type'] == 'tou' and st.session_state.get('missing_holiday_years'):
                             missing_years_str = ', '.join(map(str, sorted(list(st.session_state.missing_holiday_years))))
                             output += f"- **‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:** ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î TOU ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ: {missing_years_str}. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Off-Peak ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n"
                        if ev_enabled and charge_start_time is not None and charge_end_time is not None and charge_start_time > charge_end_time:
                             output += "- ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á EV ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ô\n"
                        output += "- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÅ‡∏•‡∏∞ Ft ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î\n"

                        st.session_state.calculation_result = output # ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•

            except Exception as calc_ex:
                 st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: {calc_ex}")
                 st.error(f"Traceback: {traceback.format_exc()}")
                 st.session_state.calculation_result = f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:\n{calc_ex}"

# --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
if st.session_state.calculation_result:
    st.markdown("---")
    st.header("3. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")
    st.code("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:", st.session_state.calculation_result, language=None, height=450, key="result_text_area", disabled=True)

    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå txt
    try:
         result_bytes = st.session_state.calculation_result.encode('utf-8')
         st.download_button(
             label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (.txt)",
             data=result_bytes,
             file_name=f"electricity_bill_result_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
             mime='text/plain'
         )
    except Exception as e:
         st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ: {e}")


# --- (Optional) ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏ü ---
if st.session_state.full_dataframe is not None and not st.session_state.full_dataframe.empty:
    st.markdown("---")
    if st.checkbox("‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß (5 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å)", key="show_parsed_data"):
        st.dataframe(st.session_state.full_dataframe.head())

    # if st.checkbox("‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü Load Profile ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)", key="show_graph"):
    #     try:
    #         # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å DataFrame ‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° EV
    #         df_display = st.session_state.full_dataframe.set_index('DateTime')
    #         st.line_chart(df_display['Total import kW demand'])
    #         st.caption("‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ kW demand ‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î")
    #     except Exception as plot_ex:
    #         st.warning(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ: {plot_ex}")
